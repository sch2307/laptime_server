<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Car racing Kookmin Invitational</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <style>@import url(//fonts.googleapis.com/earlyaccess/nanumgothic.css);</style>
  </head>
  <body>
    <h1 align="center" style="font-family:Nanum Gothic; font-weight:bold;">KESL Automobile Racing League Kookmin Invitational</h1>
    <p>학교 : <input class="form-control" type="text" id="school"></p>
    <p>팀 이름 : <input class="form-control" type="text" id="team"></p>
    <p>자동차 ID : <input class="form-control" type="text" id="inputid"></p>
    <p><button class="btn btn-info" style="width:200px" type='submit' onclick="data_append(this);">등록</button>
    <button class="btn btn-info" style="width:200px" type='reset' onclick="resetinput()">취소</button>
    <button class="btn btn-success" type='submit' style='float: right; width:300px' onclick="$('tr').remove('.teamrow');refreshdb();">Refresh DB</button><br>
    </p> <br>
    <p style="font-weight:bold; color: salmon; font-size: 28px" align='center' id='notice'>현재 주행 기록이 작성되지 않고 있습니다.</p>
    <table border="1.7" class="table" id="mainboard">
        <thead class="thead-dark">
          <tr>
              <th>소속 대학</th>
              <th>소속 팀</th>
              <th>CAR ID</th>
              <th>TOTALSCORE</th>
              <th>1st Point</th>
              <th>2nd Point</th>
              <th>3rd Point</th>
              <th>4th Point</th>
              <th>5th Point</th>
              <th>6th Point</th>
              <th>7th Point</th>
              <th>8th Point</th>
              <th>9th Point</th>
              <th>10th Point</th>
              <th>11th Point</th>
              <th>12th Point</th>
              <th>13th Point</th>
              <th>14th Point</th>
              <th>15th Point</th>
              <th>업데이트</th>
              <th>삭제</th>
          </tr>
      </thead>
    </table>
  </body>
    <script>
        function refreshdb() {
            $.get('/get_json_data', (data) => {
                data = JSON.parse(data);
                if(data.length == 0) {
                    //console.log("NO DATA");
                    return;
                } else {
                    //console.log("DATA FOUND " + data.length);
                    looper = data.length;
                    var superappender = "";
                    for(i = 0; i < looper; ++i) {
                        superappender += "<tr id=" + i + " class='teamrow'><th>" + data[i].university_name + "</th><th>" + data[i].team_name + "</th><th class='car_id'>" + data[i].car_id + "</th>";
                        superappender += "<th class='score'>" + data[i].cp_cnt + "</th>";
                        superappender += "<th class='lap1'>" + data[i].check_point_1 + "</th>";
                        superappender += "<th class='lap2'>" + data[i].check_point_2 + "</th>";
                        superappender += "<th class='lap3'>" + data[i].check_point_3 + "</th>";
                        superappender += "<th class='lap4'>" + data[i].check_point_4 + "</th>";
                        superappender += "<th class='lap5'>" + data[i].check_point_5 + "</th>";
                        superappender += "<th class='lap6'>" + data[i].check_point_6 + "</th>";
                        superappender += "<th class='lap7'>" + data[i].check_point_7 + "</th>";
                        superappender += "<th class='lap8'>" + data[i].check_point_8 + "</th>";
                        superappender += "<th class='lap9'>" + data[i].check_point_9 + "</th>";
                        superappender += "<th class='lap10'>" + data[i].check_point_10 + "</th>";
                        superappender += "<th class='lap11'>" + data[i].check_point_11 + "</th>";
                        superappender += "<th class='lap12'>" + data[i].check_point_12 + "</th>";
                        superappender += "<th class='lap13'>" + data[i].check_point_13 + "</th>";
                        superappender += "<th class='lap14'>" + data[i].check_point_14 + "</th>";
                        superappender += "<th class='lap15'>" + data[i].check_point_15 + "</th>";
                        superappender += ("<th><button class='btn btn-warning' id='" + data[i].car_id + "_' onclick='setCarId(this);'> Active </button></th><th>");
                        superappender += ("<button class='btn btn-danger' id='" + data[i].car_id + "' onclick='data_delete(this);'>확인</button></th></tr>");
                        $('#mainboard').append($(superappender));
                        superappender = "";
                    }
                }
            });
        }
    
        $(document).ready(() => {
            $('tr').remove('.teamrow'); refreshdb();
            setInterval(()=> {$('tr').remove('.teamrow'); refreshdb();}, 2500);
        });

        function setCarId(obj) {
            var btn_idx = document.getElementById(obj.getAttribute('id')).getAttribute('id');
            var car_idx = parseInt(btn_idx.substring(0, btn_idx.length));
            $.ajax({
                    type : 'POST',
                    data : {car_id : car_idx},
                    url : '/setCarId',
                    success : (result) => {
                        alert(car_idx + " 차량으로 업데이트를 시작합니다.");
                    },
                    error : (error) => {alert("서버 등록에 실패했습니다. 네트워크 환경을 검토하고 다시 시도해주시기 바랍니다.");}
                }
            );
            $("#notice").text("현재 " + car_idx + "번 차량으로 주행기록이 업데이트 중입니다.");
        }
    
        function data_append() {
            schoolname = $('#school').val();
            teamname = $('#team').val();
            car = $('#inputid').val();
    
            if(schoolname == '' || teamname == '' || car == '') {
                alert('칸을 모두 입력한 후 버튼을 눌러 주십시오.');
                return;
            }
    
            $.ajax({
                    type : 'POST',
                    data : {school: schoolname, team : teamname, car_id : car},
                    url : '/data_add',
                    success : (result) => {
                        appendstring = $("<tr id=" + teamname + "><th>" + schoolname +  "</th>" + "<th>" + teamname + "</th><th class='car_id'>" + car + "</th>" + "<th class='score'>0</th><th class='lap1'>0</th><th class='lap2'>0</th><th class='lap3'>0</th><th class='lap4'>0</th><th class='lap5'>0</th><th class='lap6'>0</th><th class='lap7'>0</th><th class='lap8'>0</th><th class='lap9'>0</th><th class='lap10'>0</th><th class='lap11'>0</th><th class='lap12'>0</th><th class='lap13'>0</th><th class='lap14'>0</th><th class='lap15'>0</th>" + '<th><button class="update">업데이트</button></th><th><button onclick="deletecol(this);">확인</button>' + "</th></tr>")
                        $('#mainboard').append(appendstring);
                        
                        /* Reset Text Input box */
                        $('#school').val('');
                        $('#team').val('');
                        $('#inputid').val('');

                        alert("팀 " + teamname + " 데이터베이스 등록 완료");
                    },
                    error : (error) => {alert("서버 등록에 실패했습니다. 네트워크 환경을 검토하고 다시 시도해주시기 바랍니다.");}
                }
            );
        }
    
        function data_delete(obj) {
            var btn_id = document.getElementById(obj.getAttribute('id')).getAttribute('id');
            $.ajax({
                    type : 'POST',
                    data : {car_id : btn_id},
                    url : '/data_delete',
                    success : (result) => {
                        var tr = $(obj).parent().parent();
                        tr.remove();
                        alert("데이터베이스 제거 완료");
                    },
                    error : (error) => {alert("데이터 제거를 실패했습니다. 네트워크 환경을 검토하고 다시 시도해주시기 바랍니다.")}
                }
            );
        }
    </script>
</html>